# 知识卡片代码映射功能实现

## 功能概述

当以下情况发生时，系统会自动检查并生成知识卡片的代码块映射：

1. **用户展开步骤时** - 检查该步骤中的知识卡片是否已经有对应的代码块映射
2. **知识卡片生成完成后** - 当新的知识卡片被创建时，自动为其建立代码映射

如果发现有知识卡片缺少代码映射，系统会：

1. 获取该步骤对应的所有代码
2. 调用LLM，输入步骤代码（按行分割）和缺少映射的知识卡片标题
3. LLM返回知识卡片与代码片段的对应关系
4. 系统创建相应的代码块和映射关系
5. **不会触发高亮**，只是静默建立映射关系

## 实现文件

### 1. 新增的Prompt函数
- **文件**: `core/llm/codeAwarePrompts.ts`
- **函数**: `constructMapKnowledgeCardsToCodePrompt`
- **输入**: 代码行数组、知识卡片标题数组
- **输出**: 符合MapCodeToSteps要求的JSON格式

### 2. 新增的Thunk
- **文件**: `gui/src/redux/thunks/codeAwareGeneration.ts`
- **函数**: `checkAndMapKnowledgeCardsToCode`
- **功能**: 
  - 检查指定步骤的知识卡片是否有代码映射
  - 对缺少映射的知识卡片调用LLM生成映射
  - 创建代码块和映射关系

### 3. 修改的组件
- **文件**: `gui/src/pages/codeaware/CodeAware.tsx`
- **函数**: `handleStepExpansionChange`
- **新功能**: 当步骤展开时，自动调用检查和映射功能

### 4. 新增的清理逻辑
- **文件**: `gui/src/redux/slices/codeAwareSlice.ts`
- **函数**: `clearKnowledgeCardCodeMappings`
- **功能**: 清除所有知识卡片的代码映射，但保留步骤到需求的映射

## 技术实现细节

### 映射清理策略
当代码生成时，系统会：
1. **清理所有知识卡片代码映射** - 因为代码内容和行号可能发生变化
2. **保留步骤到需求的映射** - 这些映射关系仍然有效
3. **在用户下次展开步骤时重新生成映射** - 懒惰加载策略

这样确保了映射关系始终准确，避免了失效的映射导致的高亮错误。

### Prompt设计
参考了`constructMapCodeToStepsPrompt`的设计，要求LLM：
- 只使用完整的代码行
- 为每个知识卡片标题找到相关的代码片段
- 返回JSON格式的映射关系
- 如果没有相关代码，返回空数组

### 代码块创建逻辑
- 使用`calculateCodeChunkRange`计算精确的行号范围
- 检查是否已存在相同的代码块，避免重复创建
- 为每个代码片段创建对应的映射关系

### 错误处理
- 步骤不存在时跳过处理
- 无知识卡片或所有知识卡片都有映射时跳过处理
- LLM调用失败时记录错误但不影响步骤展开操作
- 文件内容获取失败时使用默认行号范围

## 使用场景

1. **用户首次展开步骤**: 如果该步骤已有知识卡片但缺少代码映射，系统会自动建立映射
2. **知识卡片主题生成后**: 当系统生成新的知识卡片主题时，自动为新卡片建立代码映射
3. **用户提问生成知识卡片后**: 当用户提问触发知识卡片生成时，自动建立代码映射  
4. **全局提问生成知识卡片后**: 当全局提问触发知识卡片生成时，自动建立代码映射
5. **代码生成时清理旧映射**: 当有新代码生成时，清理所有可能失效的知识卡片代码映射
6. **懒惰重新生成**: 用户重新展开步骤时会重新建立映射关系
7. **静默操作**: 整个过程对用户透明，不会触发代码高亮或其他视觉效果

## 自动调用触发点

- `handleStepExpansionChange()` - 步骤展开时
- `generateKnowledgeCardThemes()` - 知识卡片主题生成完成后  
- `generateKnowledgeCardThemesFromQuery()` - 基于用户问题生成知识卡片后
- `processGlobalQuestion()` - 全局提问处理完成后
- `generateCodeFromSteps()` - 代码生成时清理旧映射
- `rerunStep()` - 步骤重新运行时清理旧映射

## 性能考虑

- **懒惰加载策略**: 只在步骤展开时触发，不会影响页面加载性能
- **智能清理机制**: 代码生成时清理旧映射，避免无效映射累积
- **缓存机制**: 已有映射的知识卡片不会重复处理
- **异步执行**: 不会阻塞UI操作
- **减少无效映射**: 主动清理失效映射，提高系统准确性

## 后续扩展可能

- 可以扩展到支持批量处理多个步骤的知识卡片映射
- 可以添加手动重新映射的功能
- 可以在代码变更检测时自动调用此功能
